%include <head.h>

home=/marsdev/data/max/grib_api/tests.ecmwf

name=%FAMILY1%
rm -fr /scratch/ma/max/problems/$name

# export ECCODES_DEFINITION_PATH=/home/ma/mab/src/q/definitions
here=`pwd`
cd $home

export MARS_LANGUAGE_FILE=/home/ma/max/dwd/linux/etc/mars.def
export MARS_CHECK_FILE=/home/ma/max/dwd/linux/chk/mars.chk

env | sort 

export MARS_MM_FIRSTOFMONTH=1

t=%TASK%
n=%TASK%.test

cd $here
rm -f info.$t /scratch/ma/max/problems/$name.$t
fail=0

set +e
rm -f core
$home/$n data 2>>info.$t
status=$?
[[ -f core ]] && ls -l core >> info.$t
rm -f core
set -e

if [[ $status -eq 0 ]]
then
	echo OK >> info.$t
else
	echo FAIL >> info.$t
	fail=1
fi
cat info.$t | perl -e '$/=undef;$x=substr(<>,-1024,1024);system("smslabel","info",$x);'


if [[ $fail -ne 0 ]]
then
ln -s -f %SAMPLEDIR%/%FILE% /scratch/ma/max/problems/$name.$t
# cp data /scratch/ma/max/problems/$name.$t
echo "gribprofile /scratch/ma/max/problems/$name.$t"
exit 1
fi

%include <tail.h>
